"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const router_1 = __importDefault(require("@koa/router"));
const koa2_formidable_1 = __importDefault(require("koa2-formidable"));
const utils_1 = require("./utils");
const constants_1 = require("./constants");
let session;
try {
    session = require('koa-session');
}
catch (e) {
    // eslint-disable-next-line no-console
    console.info('koa-session was not loaded');
}
/**
 * Builds regular koa router.
 * @memberof module:@admin-bro/koa
 *
 * @param {AdminBro}    admin      AdminBro instance
 * @param {Application} app        koa application created by `new Koa()`
 * @param {KoaAuthOptions} auth       authentication options
 * @param {Router}      [predefinedRouter] if you have any predefined router
 *    pass it here
 * @param {FormidableOptions} formidableOptions options passed to formidable
 *    module {@link https://github.com/node-formidable/formidable#options}
 * @return  {Router}  @koa/router
 */
const buildAuthenticatedRouter = (admin, app, auth, predefinedRouter, formidableOptions) => {
    if (!session) {
        throw new Error(['In order to use authentication, you have to install',
            'koa-session package',
        ].join(' '));
    }
    const router = predefinedRouter || new router_1.default({
        prefix: admin.options.rootPath || constants_1.DEFAULT_ROOT_PATH,
    });
    router.use(koa2_formidable_1.default(formidableOptions));
    app.use(session(app));
    utils_1.addAdminBroAuthRoutes(admin, router, auth);
    utils_1.addAdminBroRoutes(admin, router, app);
    return router;
};
exports.default = buildAuthenticatedRouter;
